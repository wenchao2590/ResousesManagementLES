/********************************************************************/
/*   Project Name:  Production Pull System                          */
/*   Program Name:  [LES].[PROC_BAS_INHOUSE_PULL_COMBINE_STANDBY]   */
/*   Called By:     by the windows service							*/
/*   Purpose:       This is the main stored procedure for the       */
/*   author:        wangchanghong	2011-06-20   				    */
/*   modify:        sunshuxiao	2017-05-19		   				    */
/********************************************************************/
CREATE PROCEDURE [LES].[PROC_BAS_INHOUSE_PULL_COMBINE_STANDBY]
AS
BEGIN
	--基础数据_物流标准拉动历史表
	TRUNCATE TABLE [LES].[TM_BAS_INHOUSE_PULL_LOGISTIC_HIS]

	INSERT INTO [LES].[TM_BAS_INHOUSE_PULL_LOGISTIC_HIS]
	(
		[PLANT],
		[ASSEMBLY_LINE],
		[PLANT_ZONE],
		[WORKSHOP],
		[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		[MODEL],
		[PART_NO],
		[INDENTIFY_PART_NO],
		[AMOUNTRATIO],
		[EXTERIOR_COLOR],
		[INTERNAL_COLOR],
		[HAND_KEPT_RECORD],
		[COLOR_CONTROL_PATCH],
		[VWS],
		[RAND],
		[SECTION],
		[PART_OPTION],
		[PRODUCTION_NUMBER],
		[START_PRODUCTION_DATE],
		[CANCEL_NUMBER],
		[END_PRODUCTION_DATE],
		[MODEL_YEAR],
		[DOSAGE],
		[MEASURING_UNIT_NO],
		[AMOUNT_FLAG],
		[DATA_DATE],
		[VORSERIE],
		[PART_CNAME],
		[PART_ENAME],
		[PART_NICKNAME],
		[LOAD_FLAG],
		[ZP_FLAG],
		[REQUIREMENT_FLAG],
		[ASSEMBLY_FLAG],
		[ASSEMBLY_FLAG_RECRUIT],
		[PURCHASE_STYLE],
		[VALID_FLAG],
		[WORKSHOP_SECTION],
		[LOCATION],
		[IN_PLANT_LOGISTIC_MODE],
		[IN_PLANT_SYSTEM_MODE],
		[IN_PLANT_LOGISTIC_PART_CLASS],
		[INHOUSE_MODE],
		[INHOUSE_SYSTEM_MODE],
		[EFFECTIVE_STATUS],
		[START_EFFECTIVE_DATE],
		[INHOUSE_PART_CLASS],
		[DOCK],
		[INHOUSE_PACKAGE_MODEL],
		[INHOUSE_PACKAGE],
		[TERMAL_PK],
		[COMMENTS],
		[UPDATE_DATE],
		[UPDATE_USER],
		[CREATE_DATE],
		[CREATE_USER],
		[LOGICAL_PK],
		[BUSINESS_PK]
	)
	SELECT
		[PLANT],
		[ASSEMBLY_LINE],
		[PLANT_ZONE],
		[WORKSHOP],
		[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		[MODEL],
		[PART_NO],
		[INDENTIFY_PART_NO],
		[AMOUNTRATIO],
		[EXTERIOR_COLOR],
		[INTERNAL_COLOR],
		[HAND_KEPT_RECORD],
		[COLOR_CONTROL_PATCH],
		[VWS],
		[RAND],
		[SECTION],
		[PART_OPTION],
		[PRODUCTION_NUMBER],
		[START_PRODUCTION_DATE],
		[CANCEL_NUMBER],
		[END_PRODUCTION_DATE],
		[MODEL_YEAR],
		[DOSAGE],
		[MEASURING_UNIT_NO],
		[AMOUNT_FLAG],
		[DATA_DATE],
		[VORSERIE],
		[PART_CNAME],
		[PART_ENAME],
		[PART_NICKNAME],
		[LOAD_FLAG],
		[ZP_FLAG],
		[REQUIREMENT_FLAG],
		[ASSEMBLY_FLAG],
		[ASSEMBLY_FLAG_RECRUIT],
		[PURCHASE_STYLE],
		[VALID_FLAG],
		[WORKSHOP_SECTION],
		[LOCATION],
		[IN_PLANT_LOGISTIC_MODE],
		[IN_PLANT_SYSTEM_MODE],
		[IN_PLANT_LOGISTIC_PART_CLASS],
		[INHOUSE_MODE],
		[INHOUSE_SYSTEM_MODE],
		[EFFECTIVE_STATUS],
		[START_EFFECTIVE_DATE],
		[INHOUSE_PART_CLASS],
		[DOCK],
		[INHOUSE_PACKAGE_MODEL],
		[INHOUSE_PACKAGE],
		[TERMAL_PK],
		[COMMENTS],
		[UPDATE_DATE],
		[UPDATE_USER],
		[CREATE_DATE],
		[CREATE_USER],
		[LOGICAL_PK],
		[BUSINESS_PK]
	FROM [LES].[TM_BAS_INHOUSE_PULL_LOGISTIC_STANDARD] WITH (NOLOCK)
	--基础数据_物流标准拉动表

	--清空物流标准拉动临时表
	TRUNCATE TABLE [LES].[TE_BAS_INHOUSE_PULL_LOGISTIC_SUBMIT]

	INSERT INTO [LES].[TE_BAS_INHOUSE_PULL_LOGISTIC_SUBMIT]
	(
		[PLANT],
		[ASSEMBLY_LINE],
		[PLANT_ZONE],
		[WORKSHOP],
		[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		[MODEL],
		[PART_NO],
		[INDENTIFY_PART_NO],
		[AMOUNTRATIO],
		[MODEL_YEAR],
		[DOSAGE],
		[MEASURING_UNIT_NO],
		[AMOUNT_FLAG],
		[DATA_DATE],
		[VORSERIE],
		[PART_CNAME],
		[PART_ENAME],
		[PART_NICKNAME],
		[LOAD_FLAG],
		[VALID_FLAG],
		[WORKSHOP_SECTION],
		[LOCATION],
		[IN_PLANT_LOGISTIC_MODE],
		[IN_PLANT_SYSTEM_MODE],
		[IN_PLANT_LOGISTIC_PART_CLASS],
		[INHOUSE_MODE],
		[INHOUSE_SYSTEM_MODE],
		[INHOUSE_PART_CLASS],
		[EFFECTIVE_STATUS],
		[DOCK],
		[INHOUSE_PACKAGE_MODEL],
		[INHOUSE_PACKAGE],
		[TERMAL_PK],
		[COMMENTS],
		[UPDATE_DATE],
		[UPDATE_USER],
		[CREATE_DATE],
		[CREATE_USER],
		[LOGICAL_PK],
		[BUSINESS_PK]
	)
	SELECT
		A.[PLANT],
		A.[ASSEMBLY_LINE],
		A.[PLANT_ZONE],
		A.[WORKSHOP],
		A.[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		'' [MODEL],
		A.[PART_NO],
		A.[PART_NO],
		100 [AMOUNTRATIO],
		'' [MODEL_YEAR],
		1 [DOSAGE],
		ISNULL(B.[PART_UNITS],1) [MEASURING_UNIT_NO],
		'+' [AMOUNT_FLAG],
		NULL [DATA_DATE],
		0 [VORSERIE],
		A.[PART_CNAME],
		A.[PART_ENAME],
		A.[PART_NICKNAME],
		'S' [LOAD_FLAG],
		1 [VALID_FLAG],
		[WORKSHOP_SECTION],
		[LOCATION],
		[IN_PLANT_LOGISTIC_MODE],
		[INHOUSE_SYSTEM_MODE] [IN_PLANT_SYSTEM_MODE],
		[INHOUSE_PART_CLASS] [IN_PLANT_LOGISTIC_PART_CLASS],
		[INHOUSE_MODE],
		[INHOUSE_SYSTEM_MODE],
		[INHOUSE_PART_CLASS],
		'1' [EFFECTIVE_STATUS],
		A.[DOCK],
		A.[INBOUND_PACKAGE_MODEL],
		A.[INBOUND_PACKAGE],
		A.[LOGICAL_PK],
		A.[COMMENTS],
		A.[UPDATE_DATE],
		A.[UPDATE_USER],
		A.[CREATE_DATE],
		A.[CREATE_USER],
		A.[LOGICAL_PK],
		A.[LOGICAL_PK]
	FROM [LES].[TM_BAS_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] A WITH (NOLOCK)
	LEFT JOIN [LES].[TM_BAS_MAINTAIN_PARTS] B WITH (NOLOCK) ON (A.[PLANT] = B.[PLANT] AND A.[PART_NO] = B.[PART_NO])
	WHERE A.[INHOUSE_SYSTEM_MODE] != 'TWD' AND A.DELETE_FLAG=0

	TRUNCATE TABLE [LES].[TE_BAS_INBOUND_PULL_LOGISTIC_SUBMIT]
	TRUNCATE TABLE [LES].[TM_BAS_INBOUND_PULL_LOGISTIC_HIS]

	INSERT INTO [LES].[TM_BAS_INBOUND_PULL_LOGISTIC_HIS]
	(
		[PLANT],
		[ASSEMBLY_LINE],
		[PLANT_ZONE],
		[WORKSHOP],
		[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		[MODEL],
		[PART_NO],
		[INDENTIFY_PART_NO],
		[AMOUNTRATIO],
		[EXTERIOR_COLOR],
		[INTERNAL_COLOR],
		[HAND_KEPT_RECORD],
		[COLOR_CONTROL_PATCH],
		[VWS],
		[RAND],
		[SECTION],
		[PART_OPTION],
		[PRODUCTION_NUMBER],
		[START_PRODUCTION_DATE],
		[CANCEL_NUMBER],
		[END_PRODUCTION_DATE],
		[MODEL_YEAR],
		[DOSAGE],
		[MEASURING_UNIT_NO],
		[AMOUNT_FLAG],
		[DATA_DATE],
		[VORSERIE],
		[PART_CNAME],
		[PART_ENAME],
		[LOAD_FLAG],
		[ZP_FLAG],
		[REQUIREMENT_FLAG],
		[LOGICAL_PK],
		[ASSEMBLY_FLAG],
		[ASSEMBLY_FLAG_RECRUIT],
		[MARK],
		[PURCHASE_STYLE],
		[VALID_FLAG],
		[INBOUND_MODE],
		[INBOUND_LOGISTIC_MODE],
		[INBOUND_SYSTEM_MODE],
		[EFFECTIVE_STATUS],
		[START_EFFECTIVE_DATE],
		[INBOUND_PART_CLASS],
		[DOCK],
		[INBOUND_PACKAGE_MODEL],
		[INBOUND_PACKAGE],
		[IS_SPLIT],
		[TERMAL_PK],
		[DIFF_FLAG],
		[COMMENTS],
		[UPDATE_DATE],
		[UPDATE_USER],
		[CREATE_DATE],
		[CREATE_USER]
	)
	SELECT
		[PLANT],
		[ASSEMBLY_LINE],
		[PLANT_ZONE],
		[WORKSHOP],
		[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		[MODEL],
		[PART_NO],
		[INDENTIFY_PART_NO],
		[AMOUNTRATIO],
		[EXTERIOR_COLOR],
		[INTERNAL_COLOR],
		[HAND_KEPT_RECORD],
		[COLOR_CONTROL_PATCH],
		[VWS],
		[RAND],
		[SECTION],
		[PART_OPTION],
		[PRODUCTION_NUMBER],
		[START_PRODUCTION_DATE],
		[CANCEL_NUMBER],
		[END_PRODUCTION_DATE],
		[MODEL_YEAR],
		[DOSAGE],
		[MEASURING_UNIT_NO],
		[AMOUNT_FLAG],
		[DATA_DATE],
		[VORSERIE],
		[PART_CNAME],
		[PART_ENAME],
		[LOAD_FLAG],
		[ZP_FLAG],
		[REQUIREMENT_FLAG],
		[LOGICAL_PK],
		[ASSEMBLY_FLAG],
		[ASSEMBLY_FLAG_RECRUIT],
		[MARK],
		[PURCHASE_STYLE],
		[VALID_FLAG],
		[INBOUND_MODE],
		[INBOUND_LOGISTIC_MODE],
		[INBOUND_SYSTEM_MODE],
		[EFFECTIVE_STATUS],
		[START_EFFECTIVE_DATE],
		[INBOUND_PART_CLASS],
		[DOCK],
		[INBOUND_PACKAGE_MODEL],
		[INBOUND_PACKAGE],
		[IS_SPLIT],
		[TERMAL_PK],
		[DIFF_FLAG],
		[COMMENTS],
		[UPDATE_DATE],
		[UPDATE_USER],
		[CREATE_DATE],
		[CREATE_USER]
	FROM [LES].[TM_BAS_INBOUND_PULL_LOGISTIC_STANDARD] WITH (NOLOCK)

	INSERT INTO [LES].[TE_BAS_INBOUND_PULL_LOGISTIC_SUBMIT]
	(
		[PLANT],
		[ASSEMBLY_LINE],
		[PLANT_ZONE],
		[WORKSHOP],
		[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		[MODEL],
		[PART_NO],
		[INDENTIFY_PART_NO],
		[AMOUNTRATIO],
		[MODEL_YEAR],
		[DOSAGE],
		[MEASURING_UNIT_NO],
		[AMOUNT_FLAG],
		[DATA_DATE],
		[VORSERIE],
		[PART_CNAME],
		[PART_ENAME],
		[PART_NICKNAME],
		[LOAD_FLAG],
		[VALID_FLAG],
		[INBOUND_MODE],
		[INBOUND_LOGISTIC_MODE],
		[INBOUND_SYSTEM_MODE],
		[INBOUND_PART_CLASS],
		[EFFECTIVE_STATUS],
		[DOCK],
		[INBOUND_PACKAGE_MODEL],
		[INBOUND_PACKAGE],
		[TERMAL_PK],
		[COMMENTS],
		[UPDATE_DATE],
		[UPDATE_USER],
		[CREATE_DATE],
		[CREATE_USER],
		[MIN],
		[MAX],
		[WAREHOUSE],
		[S_WM_NO],
		[S_ZONE_NO],
		[MIN_PULL_BOX],
		[BATCH_PULL_BOX]
	)
	SELECT
		[PLANT],
		[ASSEMBLY_LINE],
		[PLANT_ZONE],
		[WORKSHOP],
		[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		'' [MODEL],
		[PART_NO],
		[PART_NO],
		100 [AMOUNTRATIO],
		'' [MODEL_YEAR],
		1 [DOSAGE],
		1 [MEASURING_UNIT_NO],
		'+' [AMOUNT_FLAG],
		NULL [DATA_DATE],
		0 [VORSERIE],
		[PART_CNAME],
		[PART_ENAME],
		[PART_NICKNAME],
		'S' [LOAD_FLAG],
		1 [VALID_FLAG],
		[IN_PLANT_LOGISTIC_MODE],
		[IN_PLANT_LOGISTIC_MODE],
		[INHOUSE_SYSTEM_MODE] [IN_PLANT_SYSTEM_MODE],
		[INHOUSE_PART_CLASS] [IN_PLANT_LOGISTIC_PART_CLASS],
		'1' [EFFECTIVE_STATUS],
		[DOCK],
		[INBOUND_PACKAGE_MODEL],
		[INBOUND_PACKAGE],
		[LOGICAL_PK],
		[COMMENTS],
		[UPDATE_DATE],
		[UPDATE_USER],
		[CREATE_DATE],
		[CREATE_USER],
		[MIN],
		[MAX],
		[WAREHOUSE],
		[S_WM_NO],
		[S_ZONE_NO],
		[MIN_PULL_BOX],
		[BATCH_PULL_BOX]
	FROM [LES].[TM_BAS_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] WITH (NOLOCK)
	WHERE [INHOUSE_SYSTEM_MODE] = 'TWD' AND [DELETE_FLAG] = 0
END