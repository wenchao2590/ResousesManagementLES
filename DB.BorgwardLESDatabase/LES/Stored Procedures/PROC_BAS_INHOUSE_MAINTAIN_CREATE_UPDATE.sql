/********************************************************************/
/*   Project Name:  Production Pull System                          */
/*   Program Name:  PROC_BAS_INHOUSE_MAINTAIN_CREATE_UPDATE         */
/*   Called By:     by the Page										*/
/*   Purpose:       This is the main stored procedure for the       */
/*   author:        Andy Liu	2015-06-17   						*/
/*   modify:        孙述霄 增加字段 Min, Max 2017-05-19				*/
/*   modify:        XinPengZhang 2017-11-2 需求编号：Task 650       */
/********************************************************************/
CREATE PROCEDURE [LES].[PROC_BAS_INHOUSE_MAINTAIN_CREATE_UPDATE]
AS
BEGIN
	UPDATE TM
	SET TM.[PLANT] = TE.[PLANT],
		TM.[ASSEMBLY_LINE] = TE.[ASSEMBLY_LINE],
		TM.[PLANT_ZONE] = TE.[PLANT_ZONE],
		TM.[WORKSHOP] = TE.[WORKSHOP],
		TM.[SUPPLIER_NUM] = TE.[SUPPLIER_NUM],
		TM.[TRANS_SUPPLIER_NUM] = TE.[TRANS_SUPPLIER_NUM],
		TM.[PART_NO] = TE.[PART_NO],
		TM.[PART_CNAME] = TE.[PART_CNAME],
		TM.[PART_ENAME] = TE.[PART_ENAME],
		TM.[PART_NICKNAME] = TE.[PART_NICKNAME],
		TM.[WORKSHOP_SECTION] = TE.[WORKSHOP_SECTION],
		TM.[LOCATION] = TE.[LOCATION],
		TM.[IN_PLANT_LOGISTIC_MODE] = TE.[IN_PLANT_LOGISTIC_MODE],
		TM.[IN_PLANT_SYSTEM_MODE] = TE.[IN_PLANT_SYSTEM_MODE],
		TM.[IN_PLANT_LOGISTIC_PART_CLASS] = TE.[IN_PLANT_LOGISTIC_PART_CLASS],
		TM.[INHOUSE_MODE] = TE.[INHOUSE_MODE],
		TM.[INHOUSE_SYSTEM_MODE] = TE.[INHOUSE_SYSTEM_MODE],
		TM.[INHOUSE_PART_CLASS] = TE.[INHOUSE_PART_CLASS],
		TM.[LOGICAL_PK] = TE.[LOGICAL_PK],
		TM.[DELETE_FLAG] = (SELECT [DETAIL_CODE] FROM [LES].[TC_SYS_CODE_DETAIL] C WITH (NOLOCK) WHERE C.[DETAIL_VALUE] = TE.[DELETE_FLAG] AND [CODE_NAME] = 'delete_flag'),
		TM.[STORAGE_LOCATION] = TE.[STORAGE_LOCATION],
		TM.[SEQUENCE_NO] = TE.[SEQUENCE_NO],
		TM.[IS_ACTIVE] = TE.[IS_ACTIVE],
		TM.[IS_REPACK] = TE.[IS_REPACK],
		TM.[REPACK_ROUTE] = TE.[REPACK_ROUTE],
		TM.[IS_TRIGGER_PULL] = (SELECT [DETAIL_CODE] FROM [LES].[TC_SYS_CODE_DETAIL] C WITH (NOLOCK) WHERE C.[DETAIL_VALUE] = TE.[IS_TRIGGER_PULL] AND [CODE_NAME] = 'is_trigger_pull'),
		TM.[WM_NO] = TE.[WM_NO],
		TM.[ZONE_NO] = TE.[ZONE_NO],
		TM.[DLOC] = TE.[DLOC],
		TM.[INBOUND_PACKAGE_MODEL] = TE.[INBOUND_PACKAGE_MODEL],
		TM.[INBOUND_PACKAGE] = TE.[INBOUND_PACKAGE],
		TM.[ROUTE] = TE.[ROUTE],
		TM.[TRAN_TYPE] = TE.[TRAN_TYPE],
		TM.[TRAN_STYLE] = TE.[TRAN_STYLE],
		TM.[TRAN_SIZES] = TE.[TRAN_SIZES],
		TM.[CARD_NO] = TE.[CARD_NO],
		TM.[BUSINESS_PK] = TE.[BUSINESS_PK],
		TM.[COMMENTS] = TE.[COMMENTS],
		TM.[UPDATE_USER] = TE.[CREATE_USER],
		TM.[UPDATE_DATE] = GETDATE(),
		TM.[MIN] = TE.[MIN],
		TM.[MAX] = TE.[MAX],
		TM.[WAREHOUSE] = TE.[WAREHOUSE],
		TM.[S_WM_NO] = TE.[S_WM_NO],
		TM.[S_ZONE_NO] = TE.[S_ZONE_NO],
		TM.[MIN_PULL_BOX] = TE.[MIN_PULL_BOX],
		TM.[BATCH_PULL_BOX] = TE.[BATCH_PULL_BOX]
	FROM [LES].[TE_BAS_TMP_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] AS TE WITH (NOLOCK)
	INNER JOIN [LES].[TM_BAS_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] AS TM WITH (ROWLOCK)
	ON TE.[LOGICAL_PK] = TM.[LOGICAL_PK]
	WHERE TE.[VALID_FLAG] = 1 AND TE.INHOUSE_SYSTEM_MODE <> 'TWD'	

	INSERT INTO [LES].[TM_BAS_MAINTAIN_INHOUSE_LOGISTIC_STANDARD]
	(
		[PLANT],
		[ASSEMBLY_LINE],
		[PLANT_ZONE],
		[WORKSHOP],
		[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		[PART_NO],
		[PART_CNAME],
		[PART_ENAME],
		[PART_NICKNAME],
		[WORKSHOP_SECTION],
		[LOCATION],
		[IN_PLANT_LOGISTIC_MODE],
		[IN_PLANT_SYSTEM_MODE],
		[IN_PLANT_LOGISTIC_PART_CLASS],
		[INHOUSE_MODE],
		[INHOUSE_SYSTEM_MODE],
		[INHOUSE_PART_CLASS],
		[LOGICAL_PK],
		[DELETE_FLAG],
		[STORAGE_LOCATION],
		[SEQUENCE_NO],
		[IS_ACTIVE],
		[IS_REPACK],
		[REPACK_ROUTE],
		[IS_TRIGGER_PULL],
		[WM_NO],
		[ZONE_NO],
		[DLOC],
		[INBOUND_PACKAGE_MODEL],
		[INBOUND_PACKAGE],
		[ROUTE],
		[TRAN_TYPE],
		[TRAN_STYLE],
		[TRAN_SIZES],
		[CARD_NO],
		[BUSINESS_PK],
		[COMMENTS],
		[CREATE_USER],
		[CREATE_DATE],
		[UPDATE_USER],
		[UPDATE_DATE],
		[MIN],
		[MAX],
		[WAREHOUSE],
		[S_WM_NO],
		[S_ZONE_NO],
		[MIN_PULL_BOX],
		[BATCH_PULL_BOX]
	)
	SELECT
		TE.[PLANT],
		TE.[ASSEMBLY_LINE],
		TE.[PLANT_ZONE],
		TE.[WORKSHOP],
		TE.[SUPPLIER_NUM],
		TE.[TRANS_SUPPLIER_NUM],
		TE.[PART_NO],
		TE.[PART_CNAME],
		TE.[PART_ENAME],
		TE.[PART_NICKNAME],
		TE.[WORKSHOP_SECTION],
		TE.[LOCATION],
		TE.[IN_PLANT_LOGISTIC_MODE],
		TE.[IN_PLANT_SYSTEM_MODE],
		TE.[IN_PLANT_LOGISTIC_PART_CLASS],
		TE.[INHOUSE_MODE],
		TE.[INHOUSE_SYSTEM_MODE],
		TE.[INHOUSE_PART_CLASS],
		TE.[LOGICAL_PK],
		C1.[DETAIL_CODE],
		TE.[STORAGE_LOCATION],
		TE.[SEQUENCE_NO],
		TE.[IS_ACTIVE],
		TE.[IS_REPACK],
		TE.[REPACK_ROUTE],
		C2.[DETAIL_CODE],
		TE.[WM_NO],
		TE.[ZONE_NO],
		TE.[DLOC],
		TE.[INBOUND_PACKAGE_MODEL],
		TE.[INBOUND_PACKAGE],
		TE.[ROUTE],
		TE.[TRAN_TYPE],
		TE.[TRAN_STYLE],
		TE.[TRAN_SIZES],
		TE.[CARD_NO],
		TE.[BUSINESS_PK],
		TE.[COMMENTS],
		TE.[CREATE_USER],
		TE.[CREATE_DATE],
		TE.[UPDATE_USER],
		TE.[UPDATE_DATE],
		TE.[MIN],
		TE.[MAX],
		TE.[WAREHOUSE],
		TE.[S_WM_NO],
		TE.[S_ZONE_NO],
		TE.[MIN_PULL_BOX],
		TE.[BATCH_PULL_BOX]
	FROM [LES].[TE_BAS_TMP_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] TE WITH (NOLOCK)
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C1 ON  C1.[DETAIL_VALUE] = TE.[DELETE_FLAG] AND C1.[CODE_NAME] = 'delete_flag'
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C2 ON  C2.[DETAIL_VALUE] = TE.[IS_TRIGGER_PULL] AND C2.[CODE_NAME] = 'is_trigger_pull'
	WHERE TE.[VALID_FLAG] = 1 AND TE.INHOUSE_SYSTEM_MODE <> 'TWD' AND TE.[LOGICAL_PK] NOT IN (SELECT [LOGICAL_PK] FROM [LES].[TM_BAS_MAINTAIN_INHOUSE_LOGISTIC_STANDARD])

	--2017-11-2 UPDATE XinPengZhang 需求编号：Task 650
	--TWD不能根据LOGICAL_PK关联，历史数据验证重复是由工厂+流水线+零件号+零件类构成，新需求是由工厂+产线+零件号+供应商+工位+目标仓库+目标存储区构成。
	--2017-11-7 UPDATE XinPengZhang 工厂+产线+零件号+零件类唯一（需求编号：Task 662）
	UPDATE TM
	SET TM.[PLANT] = TE.[PLANT],
		TM.[ASSEMBLY_LINE] = TE.[ASSEMBLY_LINE],
		TM.[PLANT_ZONE] = TE.[PLANT_ZONE],
		TM.[WORKSHOP] = TE.[WORKSHOP],
		TM.[SUPPLIER_NUM] = TE.[SUPPLIER_NUM],
		TM.[TRANS_SUPPLIER_NUM] = TE.[TRANS_SUPPLIER_NUM],
		TM.[PART_NO] = TE.[PART_NO],
		TM.[PART_CNAME] = TE.[PART_CNAME],
		TM.[PART_ENAME] = TE.[PART_ENAME],
		TM.[PART_NICKNAME] = TE.[PART_NICKNAME],
		TM.[WORKSHOP_SECTION] = TE.[WORKSHOP_SECTION],
		TM.[LOCATION] = TE.[LOCATION],
		TM.[IN_PLANT_LOGISTIC_MODE] = TE.[IN_PLANT_LOGISTIC_MODE],
		TM.[IN_PLANT_SYSTEM_MODE] = TE.[IN_PLANT_SYSTEM_MODE],
		TM.[IN_PLANT_LOGISTIC_PART_CLASS] = TE.[IN_PLANT_LOGISTIC_PART_CLASS],
		TM.[INHOUSE_MODE] = TE.[INHOUSE_MODE],
		TM.[INHOUSE_SYSTEM_MODE] = TE.[INHOUSE_SYSTEM_MODE],
		TM.[INHOUSE_PART_CLASS] = TE.[INHOUSE_PART_CLASS],
		TM.[LOGICAL_PK] = TE.[LOGICAL_PK],
		TM.[DELETE_FLAG] = (SELECT [DETAIL_CODE] FROM [LES].[TC_SYS_CODE_DETAIL] C WITH (NOLOCK) WHERE C.[DETAIL_VALUE] = TE.[DELETE_FLAG] AND [CODE_NAME] = 'delete_flag'),
		TM.[STORAGE_LOCATION] = TE.[STORAGE_LOCATION],
		TM.[SEQUENCE_NO] = TE.[SEQUENCE_NO],
		TM.[IS_ACTIVE] = TE.[IS_ACTIVE],
		TM.[IS_REPACK] = TE.[IS_REPACK],
		TM.[REPACK_ROUTE] = TE.[REPACK_ROUTE],
		TM.[IS_TRIGGER_PULL] = (SELECT [DETAIL_CODE] FROM [LES].[TC_SYS_CODE_DETAIL] C WITH (NOLOCK) WHERE C.[DETAIL_VALUE] = TE.[IS_TRIGGER_PULL] AND [CODE_NAME] = 'is_trigger_pull'),
		TM.[WM_NO] = TE.[WM_NO],
		TM.[ZONE_NO] = TE.[ZONE_NO],
		TM.[DLOC] = TE.[DLOC],
		TM.[INBOUND_PACKAGE_MODEL] = TE.[INBOUND_PACKAGE_MODEL],
		TM.[INBOUND_PACKAGE] = TE.[INBOUND_PACKAGE],
		TM.[ROUTE] = TE.[ROUTE],
		TM.[TRAN_TYPE] = TE.[TRAN_TYPE],
		TM.[TRAN_STYLE] = TE.[TRAN_STYLE],
		TM.[TRAN_SIZES] = TE.[TRAN_SIZES],
		TM.[CARD_NO] = TE.[CARD_NO],
		TM.[BUSINESS_PK] = TE.[BUSINESS_PK],
		TM.[COMMENTS] = TE.[COMMENTS],
		TM.[UPDATE_USER] = TE.[CREATE_USER],
		TM.[UPDATE_DATE] = GETDATE(),
		TM.[MIN] = TE.[MIN],
		TM.[MAX] = TE.[MAX],
		TM.[WAREHOUSE] = TE.[WAREHOUSE],
		TM.[S_WM_NO] = TE.[S_WM_NO],
		TM.[S_ZONE_NO] = TE.[S_ZONE_NO],
		TM.[MIN_PULL_BOX] = TE.[MIN_PULL_BOX],
		TM.[BATCH_PULL_BOX] = TE.[BATCH_PULL_BOX]
	FROM [LES].[TE_BAS_TMP_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] AS TE WITH (NOLOCK)
	INNER JOIN [LES].[TM_BAS_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] AS TM WITH (ROWLOCK)
	ON TE.PLANT=TM.PLANT AND TE.ASSEMBLY_LINE=TM.ASSEMBLY_LINE AND TE.PART_NO=TM.PART_NO 
		AND TE.INHOUSE_PART_CLASS=TM.INHOUSE_PART_CLASS AND TE.LOCATION=TM.LOCATION
	WHERE TE.[VALID_FLAG] = 1 AND TE.INHOUSE_SYSTEM_MODE = 'TWD'

		INSERT INTO [LES].[TM_BAS_MAINTAIN_INHOUSE_LOGISTIC_STANDARD]
	(
		[PLANT],
		[ASSEMBLY_LINE],
		[PLANT_ZONE],
		[WORKSHOP],
		[SUPPLIER_NUM],
		[TRANS_SUPPLIER_NUM],
		[PART_NO],
		[PART_CNAME],
		[PART_ENAME],
		[PART_NICKNAME],
		[WORKSHOP_SECTION],
		[LOCATION],
		[IN_PLANT_LOGISTIC_MODE],
		[IN_PLANT_SYSTEM_MODE],
		[IN_PLANT_LOGISTIC_PART_CLASS],
		[INHOUSE_MODE],
		[INHOUSE_SYSTEM_MODE],
		[INHOUSE_PART_CLASS],
		[LOGICAL_PK],
		[DELETE_FLAG],
		[STORAGE_LOCATION],
		[SEQUENCE_NO],
		[IS_ACTIVE],
		[IS_REPACK],
		[REPACK_ROUTE],
		[IS_TRIGGER_PULL],
		[WM_NO],
		[ZONE_NO],
		[DLOC],
		[INBOUND_PACKAGE_MODEL],
		[INBOUND_PACKAGE],
		[ROUTE],
		[TRAN_TYPE],
		[TRAN_STYLE],
		[TRAN_SIZES],
		[CARD_NO],
		[BUSINESS_PK],
		[COMMENTS],
		[CREATE_USER],
		[CREATE_DATE],
		[UPDATE_USER],
		[UPDATE_DATE],
		[MIN],
		[MAX],
		[WAREHOUSE],
		[S_WM_NO],
		[S_ZONE_NO],
		[MIN_PULL_BOX],
		[BATCH_PULL_BOX]
	)
	SELECT
		TE.[PLANT],
		TE.[ASSEMBLY_LINE],
		TE.[PLANT_ZONE],
		TE.[WORKSHOP],
		TE.[SUPPLIER_NUM],
		TE.[TRANS_SUPPLIER_NUM],
		TE.[PART_NO],
		TE.[PART_CNAME],
		TE.[PART_ENAME],
		TE.[PART_NICKNAME],
		TE.[WORKSHOP_SECTION],
		TE.[LOCATION],
		TE.[IN_PLANT_LOGISTIC_MODE],
		TE.[IN_PLANT_SYSTEM_MODE],
		TE.[IN_PLANT_LOGISTIC_PART_CLASS],
		TE.[INHOUSE_MODE],
		TE.[INHOUSE_SYSTEM_MODE],
		TE.[INHOUSE_PART_CLASS],
		TE.[LOGICAL_PK],
		C1.[DETAIL_CODE],
		TE.[STORAGE_LOCATION],
		TE.[SEQUENCE_NO],
		TE.[IS_ACTIVE],
		TE.[IS_REPACK],
		TE.[REPACK_ROUTE],
		C2.[DETAIL_CODE],
		TE.[WM_NO],
		TE.[ZONE_NO],
		TE.[DLOC],
		TE.[INBOUND_PACKAGE_MODEL],
		TE.[INBOUND_PACKAGE],
		TE.[ROUTE],
		TE.[TRAN_TYPE],
		TE.[TRAN_STYLE],
		TE.[TRAN_SIZES],
		TE.[CARD_NO],
		TE.[BUSINESS_PK],
		TE.[COMMENTS],
		TE.[CREATE_USER],
		TE.[CREATE_DATE],
		TE.[UPDATE_USER],
		TE.[UPDATE_DATE],
		TE.[MIN],
		TE.[MAX],
		TE.[WAREHOUSE],
		TE.[S_WM_NO],
		TE.[S_ZONE_NO],
		TE.[MIN_PULL_BOX],
		TE.[BATCH_PULL_BOX]
	FROM [LES].[TE_BAS_TMP_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] TE WITH (NOLOCK)
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C1 ON  C1.[DETAIL_VALUE] = TE.[DELETE_FLAG] AND C1.[CODE_NAME] = 'delete_flag'
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C2 ON  C2.[DETAIL_VALUE] = TE.[IS_TRIGGER_PULL] AND C2.[CODE_NAME] = 'is_trigger_pull'
	WHERE 
	TE.[VALID_FLAG] = 1 
	AND TE.INHOUSE_SYSTEM_MODE = 'TWD' 
	AND  NOT EXISTS 
	(
		SELECT * FROM [LES].[TM_BAS_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] TM 
		WHERE 
		TE.PLANT=TM.PLANT 
		AND TE.ASSEMBLY_LINE=TM.ASSEMBLY_LINE 
		AND TE.PART_NO=TM.PART_NO 
		AND TE.INHOUSE_PART_CLASS=TM.INHOUSE_PART_CLASS
		AND TE.LOCATION=TM.LOCATION 
	)
END