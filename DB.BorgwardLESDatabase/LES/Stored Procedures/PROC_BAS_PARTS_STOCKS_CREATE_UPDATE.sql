
/********************************************************************/
/*                                                                  */
/*   Project Name:  Production Pull System                          */
/*   Program Name:  [PROC_BAS_PARTS_STOCKS_CREATE_UPDATE]           */
/*   Called By:     by the Page										*/
/*   Purpose:       This is the main stored procedure for the       */
/*   author:       Andy Liu	2015-06-24   							*/
/********************************************************************/
CREATE PROCEDURE [LES].[PROC_BAS_PARTS_STOCKS_CREATE_UPDATE]
AS
BEGIN
	UPDATE TM
	SET TM.[PLANT] = TE.[PLANT],
		TM.[ASSEMBLY_LINE] = TE.[ASSEMBLY_LINE],
		TM.[PLANT_ZONE] = TE.[PLANT_ZONE],
		TM.[WORKSHOP] = TE.[WORKSHOP],
		TM.[SUPPLIER_NUM] = TE.[SUPPLIER_NUM],
		TM.[PART_NO] = TE.[PART_NO],
		TM.[PART_CNAME] = TE.[PART_CNAME],
		TM.[PART_ENAME] = TE.[PART_ENAME],
		TM.[PART_NICKNAME] = TE.[PART_NICKNAME],
		TM.[PART_UNITS] = TE.[PART_UNITS],
		TM.[INHOUSE_PACKAGE_MODEL] = TE.[INHOUSE_PACKAGE_MODEL],
		TM.[INHOUSE_PACKAGE] = TE.[INHOUSE_PACKAGE],
		TM.[INBOUND_PACKAGE_MODEL] = TE.[INBOUND_PACKAGE_MODEL],
		TM.[INBOUND_PACKAGE] = TE.[INBOUND_PACKAGE],
		TM.[PACKAGE_MODEL] = TE.[PACKAGE_MODEL],
		TM.[PACKAGE] = TE.[PACKAGE],
		TM.[LOGICAL_PK] = TE.[LOGICAL_PK],
		TM.[DELETE_FLAG] = (SELECT [DETAIL_CODE] FROM [LES].[TC_SYS_CODE_DETAIL] C WHERE C.[DETAIL_VALUE] = TE.[DELETE_FLAG] AND [CODE_NAME] = 'delete_flag'),
		TM.[ROUTE] = TE.[ROUTE],
		TM.[ZONE_NO] = TE.[ZONE_NO],
		TM.[WM_NO] = TE.[WM_NO],
		TM.[OCCUPY_AREA] = TE.[OCCUPY_AREA],
		TM.[DLOC] = TE.[DLOC],
		TM.[MAX] = TE.[MAX],
		TM.[MIN] = TE.[MIN],
		TM.[ROW_NUMBER] = TE.[ROW_NUMBER],
		TM.[LINE_NUMBER] = TE.[LINE_NUMBER],
		TM.[HIGH_NUMBER] = TE.[HIGH_NUMBER],
		TM.[MATERIAL_GROUP] = TE.[MATERIAL_GROUP],
		TM.[KEEPER] = TE.[KEEPER],
		TM.[TRANSER] = TE.[TRANSER],
		TM.[INFORMATIONER] = TE.[INFORMATIONER],
		TM.[ELOC] = TE.[ELOC],
		TM.[SAFE_STOCK] = TE.[SAFE_STOCK],
		TM.[STOCKS] = TE.[STOCKS],
		TM.[FROZEN_STOCKS] = TE.[FROZEN_STOCKS],
		TM.[AVAILBLE_STOCKS] = TE.[AVAILBLE_STOCKS],
		TM.[IS_BATCH] = (SELECT [DETAIL_CODE] FROM [LES].[TC_SYS_CODE_DETAIL] C WHERE C.[DETAIL_VALUE] = TE.[IS_BATCH] AND [CODE_NAME] = 'parts_is_batch'),
		TM.[WMS_RULE] = TE.[WMS_RULE],
		TM.[COUNTER] = TE.[COUNTER],
		TM.[FRAGMENT_NUM] = TE.[FRAGMENT_NUM],
		TM.[PART_WEIGHT] = TE.[PART_WEIGHT],
		TM.[PART_CLS] = (SELECT [DETAIL_CODE] FROM [LES].[TC_SYS_CODE_DETAIL] C WHERE C.[DETAIL_VALUE] = TE.[PART_CLS] AND [CODE_NAME] = 'part_category'),
		TM.[IS_REPACK] = (SELECT [DETAIL_CODE] FROM [LES].[TC_SYS_CODE_DETAIL] C WHERE C.[DETAIL_VALUE] = TE.[IS_REPACK] AND [CODE_NAME] = 'is_repack'),
		TM.[REPACK_ROUTE] = TE.[REPACK_ROUTE],
		TM.[IS_TRIGGER_PULL] = (SELECT [DETAIL_CODE] FROM [LES].[TC_SYS_CODE_DETAIL] C WHERE C.[DETAIL_VALUE] = TE.[IS_TRIGGER_PULL] AND [CODE_NAME] = 'is_trigger_pull'),
		TM.[TRIGGER_WM_NO] = TE.[TRIGGER_WM_NO],
		TM.[TRIGGER_ZONE_NO] = TE.[TRIGGER_ZONE_NO],
		TM.[TRIGGER_DLOC] = TE.[TRIGGER_DLOC],
		TM.[EMG_TIME] = TE.[EMG_TIME],
		TM.[SUPPER_ZONE_DLOC] = TE.[SUPPER_ZONE_DLOC],
		TM.[CHECK_TYPE] = TE.[CHECK_TYPE],
		TM.[BUSINESS_PK] = TE.[BUSINESS_PK],
		TM.[REPACKAGE_AMOUNT] = TE.[REPACKAGE_AMOUNT],
		TM.[PICKUP_ROUTE] = TE.[PICKUP_ROUTE],
		TM.[SHELF_ROUTE] = TE.[SHELF_ROUTE],
		TM.[COMMENTS] = TE.[COMMENTS],
		TM.[CREATE_USER] = TE.[CREATE_USER],
		TM.[CREATE_DATE] = TE.[CREATE_DATE],
		TM.[UPDATE_USER] = TE.CREATE_USER,
		TM.[TRAY_PACKAGE_MODEL] = TE.[TRAY_PACKAGE_MODEL],
		TM.[TRAY_MODEL] = TE.[TRAY_MODEL],
		TM.[TRAY_OUT_ISALL] = TE.[TRAY_OUT_ISALL],
		TM.[BATCH_COMMEND_WAY] = TE.[BATCH_COMMEND_WAY],
		TM.[BACK_STOCK_RULE] = TE.[BACK_STOCK_RULE],
		TM.[PART_CLASSIFY_AREA_NO] = TE.[PART_CLASSIFY_AREA_NO],
		TM.[IS_CREATE_TASK] = TE.[IS_CREATE_TASK],
		TM.[VALUE_SORT] = TE.[VALUE_SORT],
		TM.[PARTS_ATTRIBUTE] = TE.[PARTS_ATTRIBUTE],
		TM.UPDATE_DATE = GETDATE()
	FROM [LES].[TE_BAS_TMP_PARTS_STOCK] AS TE
	INNER JOIN [LES].[TM_BAS_PARTS_STOCK] AS TM WITH (ROWLOCK) ON TE.[LOGICAL_PK] = TM.[LOGICAL_PK]
	WHERE TE.[VALID_FLAG] = 1

	INSERT INTO [LES].[TM_BAS_PARTS_STOCK]
	(
		[PLANT],
        [ASSEMBLY_LINE],
        [PLANT_ZONE],
        [WORKSHOP],
        [SUPPLIER_NUM],
        [PART_NO],
        [PART_CNAME],
        [PART_ENAME],
        [PART_NICKNAME],
        [PART_UNITS],
        [INHOUSE_PACKAGE_MODEL],
        [INHOUSE_PACKAGE],
        [INBOUND_PACKAGE_MODEL],
        [INBOUND_PACKAGE],
        [PACKAGE_MODEL],
        [PACKAGE],
        [LOGICAL_PK],
        [DELETE_FLAG],
        [ROUTE],
        [ZONE_NO],
        [WM_NO],
        [OCCUPY_AREA],
        [DLOC],
        [MAX],
        [MIN],
        [ROW_NUMBER],
        [LINE_NUMBER],
        [HIGH_NUMBER],
        [MATERIAL_GROUP],
        [KEEPER],
        [TRANSER],
        [INFORMATIONER],
        [ELOC],
        [SAFE_STOCK],
        [STOCKS],
        [FROZEN_STOCKS],
        [AVAILBLE_STOCKS],
        [IS_BATCH],
        [WMS_RULE],
        [COUNTER],
        [FRAGMENT_NUM],
        [PART_WEIGHT],
        [PART_CLS],
        [IS_REPACK],
        [REPACK_ROUTE],
        [IS_TRIGGER_PULL],
        [TRIGGER_WM_NO],
        [TRIGGER_ZONE_NO],
        [TRIGGER_DLOC],
        [EMG_TIME],
        [SUPPER_ZONE_DLOC],
        [CHECK_TYPE],
        [BUSINESS_PK],
        [REPACKAGE_AMOUNT],
        [PICKUP_ROUTE],
        [SHELF_ROUTE],
        [COMMENTS],
        [CREATE_USER],
        [CREATE_DATE],
        [UPDATE_USER],
        [UPDATE_DATE],
        [TRAY_PACKAGE_MODEL],
        [TRAY_MODEL],
        [TRAY_OUT_ISALL],
        [BATCH_COMMEND_WAY],
        [BACK_STOCK_RULE],
        [PART_CLASSIFY_AREA_NO],
        [IS_CREATE_TASK],
		[VALUE_SORT],
		[PARTS_ATTRIBUTE]
	)
	SELECT
		TE.[PLANT],
		TE.[ASSEMBLY_LINE],
		TE.[PLANT_ZONE],
		TE.[WORKSHOP],
		TE.[SUPPLIER_NUM],
		TE.[PART_NO],
		TE.[PART_CNAME],
		TE.[PART_ENAME],
		TE.[PART_NICKNAME],
		TE.[PART_UNITS],
		TE.[INHOUSE_PACKAGE_MODEL],
		TE.[INHOUSE_PACKAGE],
		TE.[INBOUND_PACKAGE_MODEL],
		TE.[INBOUND_PACKAGE],
		TE.[PACKAGE_MODEL],
		TE.[PACKAGE],
		TE.[LOGICAL_PK],
		C1.[DETAIL_CODE],
		TE.[ROUTE],
		TE.[ZONE_NO],
		TE.[WM_NO],
		TE.[OCCUPY_AREA],
		TE.[DLOC],
		TE.[MAX],
		TE.[MIN],
		TE.[ROW_NUMBER],
		TE.[LINE_NUMBER],
		TE.[HIGH_NUMBER],
		TE.[MATERIAL_GROUP],
		TE.[KEEPER],
		TE.[TRANSER],
		TE.[INFORMATIONER],
		TE.[ELOC],
		TE.[SAFE_STOCK],
		TE.[STOCKS],
		TE.[FROZEN_STOCKS],
		TE.[AVAILBLE_STOCKS],
		C5.[DETAIL_CODE],
		TE.[WMS_RULE],
		TE.[COUNTER],
		TE.[FRAGMENT_NUM],
		TE.[PART_WEIGHT],
		C2.[DETAIL_CODE],
		C3.[DETAIL_CODE],
		TE.[REPACK_ROUTE],
		C4.[DETAIL_CODE],
		TE.[TRIGGER_WM_NO],
		TE.[TRIGGER_ZONE_NO],
		TE.[TRIGGER_DLOC],
		TE.[EMG_TIME],
		TE.[SUPPER_ZONE_DLOC],
		TE.[CHECK_TYPE],
		TE.[BUSINESS_PK],
		TE.[REPACKAGE_AMOUNT],
		TE.[PICKUP_ROUTE],
		TE.[SHELF_ROUTE],
		TE.[COMMENTS],
		TE.[CREATE_USER],
		TE.[CREATE_DATE],
		TE.[UPDATE_USER],
		TE.[UPDATE_DATE],
		TE.[TRAY_PACKAGE_MODEL],
		TE.[TRAY_MODEL],
		TE.[TRAY_OUT_ISALL],
		TE.[BATCH_COMMEND_WAY],
		TE.[BACK_STOCK_RULE],
		TE.[PART_CLASSIFY_AREA_NO],
		TE.[IS_CREATE_TASK],
		TE.[VALUE_SORT],
		TE.[PARTS_ATTRIBUTE]
	FROM [LES].[TE_BAS_TMP_PARTS_STOCK] TE WITH (NOLOCK)
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C1 WITH (NOLOCK) ON  C1.[DETAIL_VALUE] = TE.[DELETE_FLAG] AND C1.[CODE_NAME] = 'delete_flag'
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C2 WITH (NOLOCK) ON  C2.[DETAIL_VALUE] = TE.[PART_CLS] AND C2.[CODE_NAME] = 'part_category'		   
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C3 WITH (NOLOCK) ON  C3.[DETAIL_VALUE] = TE.[IS_REPACK] AND C3.[CODE_NAME] = 'is_repack'
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C4 WITH (NOLOCK) ON  C4.[DETAIL_VALUE] = TE.[IS_TRIGGER_PULL] AND C4.[CODE_NAME] = 'is_trigger_pull'
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C5 WITH (NOLOCK) ON  C5.[DETAIL_VALUE] = TE.[IS_BATCH] AND C5.[CODE_NAME] = 'parts_is_batch'
	WHERE TE.[VALID_FLAG] = 1 AND TE.[LOGICAL_PK] NOT IN (SELECT [LOGICAL_PK] FROM [LES].[TM_BAS_PARTS_STOCK] WITH (NOLOCK))

	INSERT INTO [LES].[TM_BAS_PARTS_STOCK_TMP_UPDATE]
	(
		[PLANT],
        [ASSEMBLY_LINE],
        [PLANT_ZONE],
        [WORKSHOP],
        [SUPPLIER_NUM],
        [PART_NO],
        [PART_CNAME],
        [PART_ENAME],
        [PART_NICKNAME],
        [PART_UNITS],
        [INHOUSE_PACKAGE_MODEL],
        [INHOUSE_PACKAGE],
        [INBOUND_PACKAGE_MODEL],
        [INBOUND_PACKAGE],
        [PACKAGE_MODEL],
        [PACKAGE],
        [LOGICAL_PK],
        [DELETE_FLAG],
        [ROUTE],
        [ZONE_NO],
        [WM_NO],
        [OCCUPY_AREA],
        [DLOC],
        [MAX],
        [MIN],
        [ROW_NUMBER],
        [LINE_NUMBER],
        [HIGH_NUMBER],
        [MATERIAL_GROUP],
        [KEEPER],
        [TRANSER],
        [INFORMATIONER],
        [ELOC],
        [SAFE_STOCK],
        [STOCKS],
        [FROZEN_STOCKS],
        [AVAILBLE_STOCKS],
        [IS_BATCH],
        [WMS_RULE],
        [COUNTER],
        [FRAGMENT_NUM],
        [PART_WEIGHT],
        [PART_CLS],
        [IS_REPACK],
        [REPACK_ROUTE],
        [IS_TRIGGER_PULL],
        [TRIGGER_WM_NO],
        [TRIGGER_ZONE_NO],
        [TRIGGER_DLOC],
        [EMG_TIME],
        [SUPPER_ZONE_DLOC],
        [CHECK_TYPE],
        [BUSINESS_PK],
        [REPACKAGE_AMOUNT],
        [PICKUP_ROUTE],
        [SHELF_ROUTE],
        [COMMENTS],
        [CREATE_USER],
        [CREATE_DATE],
        [UPDATE_USER],
        [UPDATE_DATE],
        [TRAY_PACKAGE_MODEL],
        [TRAY_MODEL],
        [TRAY_OUT_ISALL],
        [BATCH_COMMEND_WAY],
        [BACK_STOCK_RULE],
        [PART_CLASSIFY_AREA_NO],
        [IS_CREATE_TASK],
		[VALUE_SORT],
		[PARTS_ATTRIBUTE]
	)
	SELECT
		TE.[PLANT],
		TE.[ASSEMBLY_LINE],
		TE.[PLANT_ZONE],
		TE.[WORKSHOP],
		TE.[SUPPLIER_NUM],
		TE.[PART_NO],
		TE.[PART_CNAME],
		TE.[PART_ENAME],
		TE.[PART_NICKNAME],
		TE.[PART_UNITS],
		TE.[INHOUSE_PACKAGE_MODEL],
		TE.[INHOUSE_PACKAGE],
		TE.[INBOUND_PACKAGE_MODEL],
		TE.[INBOUND_PACKAGE],
		TE.[PACKAGE_MODEL],
		TE.[PACKAGE],
		TE.[LOGICAL_PK],
		C1.[DETAIL_CODE],
		TE.[ROUTE],
		TE.[ZONE_NO],
		TE.[WM_NO],
		TE.[OCCUPY_AREA],
		TE.[DLOC],
		TE.[MAX],
		TE.[MIN],
		TE.[ROW_NUMBER],
		TE.[LINE_NUMBER],
		TE.[HIGH_NUMBER],
		TE.[MATERIAL_GROUP],
		TE.[KEEPER],
		TE.[TRANSER],
		TE.[INFORMATIONER],
		TE.[ELOC],
		TE.[SAFE_STOCK],
		TE.[STOCKS],
		TE.[FROZEN_STOCKS],
		TE.[AVAILBLE_STOCKS],
		C5.[DETAIL_CODE],
		TE.[WMS_RULE],
		TE.[COUNTER],
		TE.[FRAGMENT_NUM],
		TE.[PART_WEIGHT],
		C2.[DETAIL_CODE],
		C3.[DETAIL_CODE],
		TE.[REPACK_ROUTE],
		C4.[DETAIL_CODE],
		TE.[TRIGGER_WM_NO],
		TE.[TRIGGER_ZONE_NO],
		TE.[TRIGGER_DLOC],
		TE.[EMG_TIME],
		TE.[SUPPER_ZONE_DLOC],
		TE.[CHECK_TYPE],
		TE.[BUSINESS_PK],
		TE.[REPACKAGE_AMOUNT],
		TE.[PICKUP_ROUTE],
		TE.[SHELF_ROUTE],
		TE.[COMMENTS],
		TE.[CREATE_USER],
		TE.[CREATE_DATE],
		TE.[UPDATE_USER],
		TE.[UPDATE_DATE],
		TE.[TRAY_PACKAGE_MODEL],
		TE.[TRAY_MODEL],
		TE.[TRAY_OUT_ISALL],
		TE.[BATCH_COMMEND_WAY],
		TE.[BACK_STOCK_RULE],
		TE.[PART_CLASSIFY_AREA_NO],
		TE.[IS_CREATE_TASK],
		TE.[VALUE_SORT],
		TE.[PARTS_ATTRIBUTE]
	FROM [LES].[TE_BAS_TMP_PARTS_STOCK] TE WITH (NOLOCK)
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C1 WITH (NOLOCK) ON C1.[DETAIL_VALUE] = TE.[DELETE_FLAG] AND C1.[CODE_NAME] = 'delete_flag'
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C2 WITH (NOLOCK) ON C2.[DETAIL_VALUE] = TE.[PART_CLS] AND C2.[CODE_NAME] = 'part_category'		   
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C3 WITH (NOLOCK) ON C3.[DETAIL_VALUE] = TE.[IS_REPACK] AND C3.[CODE_NAME] = 'is_repack'
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C4 WITH (NOLOCK) ON C4.[DETAIL_VALUE] = TE.[IS_TRIGGER_PULL] AND C4.[CODE_NAME] = 'is_trigger_pull'
	LEFT JOIN [LES].[TC_SYS_CODE_DETAIL] C5 WITH (NOLOCK) ON C5.[DETAIL_VALUE] = TE.[IS_BATCH] AND C5.[CODE_NAME] = 'parts_is_batch'
	WHERE TE.[VALID_FLAG] = 1

	--更新拉动信息中的拉动包装器具编号及拉动包装数
	--UPDATE A
	--SET A.[INBOUND_PACKAGE_MODEL] = B.[INBOUND_PACKAGE_MODEL],
	--	A.[INBOUND_PACKAGE] = B.[INBOUND_PACKAGE]
	--FROM [LES].[TM_BAS_MAINTAIN_INHOUSE_LOGISTIC_STANDARD] A WITH (ROWLOCK)
	--INNER JOIN [LES].[TE_BAS_TMP_PARTS_STOCK] B WITH (NOLOCK)
	--ON A.[PLANT] = B.[PLANT] AND A.[WAREHOUSE] = B.[WM_NO] AND A.[PLANT_ZONE] = B.[ZONE_NO] AND A.[PART_NO] = B.[PART_NO]
	--WHERE ISNULL(B.[INBOUND_PACKAGE_MODEL], '') <> '' AND ISNULL(B.[INBOUND_PACKAGE], 0) <> 0
END