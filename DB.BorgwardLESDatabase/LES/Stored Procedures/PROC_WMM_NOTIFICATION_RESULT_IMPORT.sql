CREATE PROCEDURE [LES].[PROC_WMM_NOTIFICATION_RESULT_IMPORT]
AS
BEGIN
	DECLARE @NOTIFICATIONIDs NVARCHAR(MAX)
	SELECT
		@NOTIFICATIONIDs=(SELECT DISTINCT STR(D.NOTIFICATIONID) + ','
	FROM [LES].[TT_WMM_NOTIFICATION_HEAD] M WITH (NOLOCK)
	LEFT JOIN [LES].[TE_WMM_NOTIFICATION_RESULT_TEMP] T WITH (NOLOCK) ON M.[NOTIFICATION_NO] = T.[NOTIFICATION_NO]		 
	LEFT JOIN [LES].[TT_WMM_NOTIFICATION_DETAIL] D (NOLOCK) ON M.[NOTIFICATION_ID] = D.[NOTIFICATIONID]
	WHERE T.[PART_NO] = D.[PART_NO] AND ISNULL(T.[SUPPLIER_NUM], '') = ISNULL(D.[SUPPLIER_NUM], '') FOR XML PATH('')) 
	SET  @NOTIFICATIONIDs = LEFT(@NOTIFICATIONIDs, LEN(@NOTIFICATIONIDs)-1)
	DECLARE @delIMPORT NVARCHAR(MAX)
	SET @delIMPORT = 'DELETE FROM [LES].TM_WMM_NOTIFICATION_DETAIL_IMPORT WHERE NOTIFICATIONID IN ('+@NOTIFICATIONIDs+');';
	EXEC(@delIMPORT)

	INSERT INTO [LES].[TM_WMM_NOTIFICATION_DETAIL_IMPORT]			
	(
		[NOTIFICATIONID],
		TRAN_ID,
        [PLANT],
        [WM_NO],
        [PART_NO],
        [PART_CNAME],
        [ZONE_NO],
        [ULOC],
        [LOCATION],
        [PART_TYPE],
        [NUM],
        [REAL_NUM],
        [FREEZE_NUM],
        [BARCODE_DATA],
        [BARCODE_TYPE],
        [TRAN_STATE],
        [COMMENTS],
        [CREATE_USER],
        [CREATE_DATE],
		[SUPPLIER_NUM]
	)
	SELECT DISTINCT
		M.NOTIFICATION_ID AS [NOTIFICATIONID],
		D.TRAN_ID,
		D.PLANT,
		D.WM_NO,
		D.PART_NO,
		D.PART_CNAME,
		D.ZONE_NO,
		D.DLOC,
		D.LOCATION,
		D.PART_TYPE,
		D.NUM,
		T.REAL_NUM,
		NULL AS [FREEZE_NUM],
		NULL AS [BARCODE_DATA],
		NULL AS [BARCODE_TYPE],
		NULL AS [TRAN_STATE],
		T.[COMMENTS],
		T.[CREATE_USER],
		T.[CREATE_DATE],
		ISNULL(T.[SUPPLIER_NUM], '') AS [SUPPLIER_NUM]
	FROM [LES].[TE_WMM_NOTIFICATION_RESULT_TEMP] T WITH (NOLOCK) 
	LEFT JOIN [LES].[TT_WMM_NOTIFICATION_HEAD] M WITH (NOLOCK) ON M.NOTIFICATION_NO = T.NOTIFICATION_NO
	LEFT JOIN [LES].[TT_WMM_NOTIFICATION_DETAIL] D WITH (NOLOCK) ON M.NOTIFICATION_ID = D.NOTIFICATIONID AND T.PART_NO = D.PART_NO AND ISNULL(T.[SUPPLIER_NUM], '') = ISNULL(D.[SUPPLIER_NUM], '')

	UPDATE M
	SET M.[COUNT_STATUS] = 3,
		M.[UPDATE_DATE] = GETDATE(),
		M.[UPDATE_USER] = T.CREATE_USER
	FROM [LES].[TE_WMM_NOTIFICATION_RESULT_TEMP] T WITH (NOLOCK)
	INNER JOIN LES.TT_WMM_NOTIFICATION_HEAD M WITH (ROWLOCK) ON T.[NOTIFICATION_NO] = M.[NOTIFICATION_NO]
END